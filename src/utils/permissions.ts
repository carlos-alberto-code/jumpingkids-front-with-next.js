import { User } from '../types/auth';

export interface UserPermissions {
    // ‚úÖ NAVEGACI√ìN B√ÅSICA - Todos los usuarios autenticados
    canAccessExercises: boolean;
    canAccessOwnTraining: boolean;      // Ni√±os pueden ver SU entrenamiento
    canAccessOwnAssignments: boolean;   // Ni√±os pueden ver SUS asignaciones
    canAccessOwnProgress: boolean;      // Ni√±os pueden ver SU progreso

    // üèÜ GAMIFICACI√ìN Y RECOMPENSAS
    canAccessBasicRewards: boolean;        // Logros b√°sicos para todos los ni√±os
    canAccessPremiumRewards: boolean;      // Logros premium adicionales
    canAccessChallenges: boolean;          // Desaf√≠os semanales (solo premium)

    // üéØ EJERCICIOS
    canAccessPremiumExercises: boolean;
    canCreateCustomExercises: boolean;
    maxExercisesPerDay?: number; // undefined = ilimitado

    // üìã RUTINAS
    canCreatePersonalRoutines: boolean;
    canAccessPremiumRoutines: boolean;
    canShareRoutines: boolean;
    maxRoutinesStored?: number; // undefined = ilimitado

    // üìä ENTRENAMIENTO Y SEGUIMIENTO
    canTrackProgress: boolean;
    canAccessAdvancedMetrics: boolean;
    canExportData: boolean;

    // üë®‚Äçüë©‚Äçüëß‚Äçüë¶ GESTI√ìN (espec√≠fico para tutores)
    canManageKids: boolean;              // Cualquier tutor puede gestionar
    canManageMultipleKids: boolean;      // Solo premium: m√∫ltiples hijos
    canAccessAnalytics: boolean;
    canCreateExercisesForKids: boolean;
    canAssignRoutines: boolean;          // Cualquier tutor puede asignar

    // üí≥ SUSCRIPCI√ìN
    canUpgradeSubscription: boolean;

    // üìä REPORTES Y CONFIGURACIONES
    canAccessBasicReports: boolean;        // Reportes b√°sicos para todos los tutores
    canAccessAdvancedReports: boolean;     // Reportes avanzados con gr√°ficos y comparativas
    canExportReports: boolean;             // Exportar reportes a PDF
    canAccessAdvancedSettings: boolean;    // Configuraciones avanzadas de la aplicaci√≥n
}

/**
 * üéØ NUEVA FILOSOF√çA: "Acceso amplio, funcionalidades limitadas"
 * - Los ni√±os pueden ver SUS datos (training, assignments, progress)
 * - Los tutores pueden gestionar (con limitaciones seg√∫n suscripci√≥n)
 * - Solo restringimos funcionalidades avanzadas, no navegaci√≥n b√°sica
 */
export function getUserPermissions(user: User | null): UserPermissions {
    // Usuario no autenticado - solo navegaci√≥n an√≥nima
    if (!user) {
        return {
            canAccessExercises: true,                // ‚úÖ Navegaci√≥n an√≥nima permitida
            canAccessOwnTraining: false,
            canAccessOwnAssignments: false,
            canAccessOwnProgress: false,
            canAccessBasicRewards: false,
            canAccessPremiumRewards: false,
            canAccessChallenges: false,
            canAccessPremiumExercises: false,
            canCreateCustomExercises: false,
            maxExercisesPerDay: 3,
            canCreatePersonalRoutines: false,
            canAccessPremiumRoutines: false,
            canShareRoutines: false,
            maxRoutinesStored: 0,
            canTrackProgress: false,
            canAccessAdvancedMetrics: false,
            canExportData: false,
            canManageKids: false,
            canManageMultipleKids: false,
            canAccessAnalytics: false,
            canCreateExercisesForKids: false,
            canAssignRoutines: false,
            canUpgradeSubscription: true,
            canAccessBasicReports: false,          // Ni√±os no tienen reportes
            canAccessAdvancedReports: false,       // Ni√±os no tienen reportes
            canExportReports: false,               // Ni√±os no exportan
            canAccessAdvancedSettings: false       // Ni√±os no configuran
        };
    }

    const { userType: type, subscription } = user;

    // üëß NI√ëO FREE
    if (type === 'kid' && subscription === 'free') {
        return {
            canAccessExercises: true,               // ‚úÖ Puede ver ejercicios
            canAccessOwnTraining: true,             // ‚úÖ Puede entrenar
            canAccessOwnAssignments: true,          // ‚úÖ Puede ver sus asignaciones
            canAccessOwnProgress: true,             // ‚úÖ Puede ver su progreso
            canAccessBasicRewards: true,            // ‚úÖ Recompensas b√°sicas
            canAccessPremiumRewards: false,         // ‚ùå Sin recompensas premium
            canAccessChallenges: false,             // ‚ùå Sin desaf√≠os
            canAccessPremiumExercises: false,       // ‚ùå Sin ejercicios premium
            canCreateCustomExercises: false,
            maxExercisesPerDay: 5,
            canCreatePersonalRoutines: false,
            canAccessPremiumRoutines: false,
            canShareRoutines: false,
            maxRoutinesStored: 1,
            canTrackProgress: true,                 // ‚úÖ Seguimiento b√°sico
            canAccessAdvancedMetrics: false,       // ‚ùå Sin m√©tricas avanzadas
            canExportData: false,
            canManageKids: false,
            canManageMultipleKids: false,
            canAccessAnalytics: false,
            canCreateExercisesForKids: false,
            canAssignRoutines: false,
            canUpgradeSubscription: true,
            canAccessBasicReports: false,          // Ni√±os no tienen reportes
            canAccessAdvancedReports: false,       // Ni√±os no tienen reportes
            canExportReports: false,               // Ni√±os no exportan
            canAccessAdvancedSettings: false       // Ni√±os no configuran
        };
    }

    // üë¶ NI√ëO PREMIUM
    if (type === 'kid' && subscription === 'premium') {
        return {
            canAccessExercises: true,               // ‚úÖ Puede ver ejercicios
            canAccessOwnTraining: true,             // ‚úÖ Puede entrenar
            canAccessOwnAssignments: true,          // ‚úÖ Puede ver sus asignaciones
            canAccessOwnProgress: true,             // ‚úÖ Puede ver su progreso
            canAccessBasicRewards: true,            // ‚úÖ Recompensas b√°sicas
            canAccessPremiumRewards: true,          // ‚úÖ Recompensas premium
            canAccessChallenges: true,              // ‚úÖ Desaf√≠os semanales
            canAccessPremiumExercises: true,        // ‚úÖ Ejercicios premium
            canCreateCustomExercises: false,        // Solo tutores
            maxExercisesPerDay: undefined,          // Ilimitado
            canCreatePersonalRoutines: true,
            canAccessPremiumRoutines: true,
            canShareRoutines: false,                // Solo tutores
            maxRoutinesStored: 10,
            canTrackProgress: true,
            canAccessAdvancedMetrics: true,         // ‚úÖ M√©tricas avanzadas
            canExportData: false,                   // Solo tutores
            canManageKids: false,
            canManageMultipleKids: false,
            canAccessAnalytics: false,
            canCreateExercisesForKids: false,
            canAssignRoutines: false,
            canUpgradeSubscription: false,          // Ya es premium
            canAccessBasicReports: false,          // Ni√±os no tienen reportes
            canAccessAdvancedReports: false,       // Ni√±os no tienen reportes
            canExportReports: false,               // Ni√±os no exportan
            canAccessAdvancedSettings: false       // Ni√±os no configuran
        };
    }

    // üë©‚Äçüè´ TUTOR FREE
    if (type === 'tutor' && subscription === 'free') {
        return {
            canAccessExercises: true,               // ‚úÖ Puede ver ejercicios
            canAccessOwnTraining: false,            // Los tutores no entrenan
            canAccessOwnAssignments: false,         // Los tutores no tienen asignaciones
            canAccessOwnProgress: false,            // Los tutores no tienen progreso personal
            canAccessBasicRewards: false,           // Tutores no tienen gamificaci√≥n
            canAccessPremiumRewards: false,         // Tutores no tienen gamificaci√≥n
            canAccessChallenges: false,             // Tutores no tienen gamificaci√≥n
            canAccessPremiumExercises: false,
            canCreateCustomExercises: false,
            maxExercisesPerDay: 5,
            canCreatePersonalRoutines: false,
            canAccessPremiumRoutines: false,
            canShareRoutines: false,
            maxRoutinesStored: 3,
            canTrackProgress: true,                 // ‚úÖ Puede ver progreso de hijos
            canAccessAdvancedMetrics: false,
            canExportData: false,
            canManageKids: true,                    // ‚úÖ Puede gestionar hijos
            canManageMultipleKids: false,           // ‚ùå Solo 1 hijo
            canAccessAnalytics: false,
            canCreateExercisesForKids: false,
            canAssignRoutines: true,                // ‚úÖ Puede asignar rutinas
            canUpgradeSubscription: true,
            canAccessBasicReports: true,           // ‚úÖ Reportes b√°sicos
            canAccessAdvancedReports: false,       // ‚ùå Sin reportes avanzados
            canExportReports: false,               // ‚ùå Sin exportaci√≥n
            canAccessAdvancedSettings: false       // ‚ùå Solo configuraciones b√°sicas
        };
    }

    // üë®‚Äçüè´ TUTOR PREMIUM
    if (type === 'tutor' && subscription === 'premium') {
        return {
            canAccessExercises: true,               // ‚úÖ Puede ver ejercicios
            canAccessOwnTraining: false,            // Los tutores no entrenan
            canAccessOwnAssignments: false,         // Los tutores no tienen asignaciones
            canAccessOwnProgress: false,            // Los tutores no tienen progreso personal
            canAccessBasicRewards: false,           // Tutores no tienen gamificaci√≥n
            canAccessPremiumRewards: false,         // Tutores no tienen gamificaci√≥n
            canAccessChallenges: false,             // Tutores no tienen gamificaci√≥n
            canAccessPremiumExercises: true,
            canCreateCustomExercises: true,
            maxExercisesPerDay: undefined,          // Ilimitado
            canCreatePersonalRoutines: true,
            canAccessPremiumRoutines: true,
            canShareRoutines: true,
            maxRoutinesStored: undefined,           // Ilimitado
            canTrackProgress: true,
            canAccessAdvancedMetrics: true,
            canExportData: true,
            canManageKids: true,                    // ‚úÖ Puede gestionar hijos
            canManageMultipleKids: true,            // ‚úÖ Hasta 3 hijos
            canAccessAnalytics: true,
            canCreateExercisesForKids: true,
            canAssignRoutines: true,                // ‚úÖ Puede asignar rutinas
            canUpgradeSubscription: false,          // Ya es premium
            canAccessBasicReports: true,           // ‚úÖ Reportes b√°sicos
            canAccessAdvancedReports: true,        // ‚úÖ Reportes avanzados
            canExportReports: true,                // ‚úÖ Exportaci√≥n completa
            canAccessAdvancedSettings: true        // ‚úÖ Configuraciones avanzadas
        };
    }

    // Fallback - permisos m√≠nimos por seguridad
    return getUserPermissions(null);
}

/**
 * ‚úÖ FUNCIONES HELPER ACTUALIZADAS
 */
export const checkPermissions = {
    canCreateContent: (user: User | null): boolean => {
        const perms = getUserPermissions(user);
        return perms.canCreateCustomExercises || perms.canCreateExercisesForKids;
    },

    isPremiumUser: (user: User | null): boolean => {
        return user?.subscription === 'premium';
    },

    isTutor: (user: User | null): boolean => {
        return user?.userType === 'tutor';
    },

    isKid: (user: User | null): boolean => {
        return user?.userType === 'kid';
    },

    needsUpgrade: (user: User | null): boolean => {
        return getUserPermissions(user).canUpgradeSubscription;
    },

    canAccessFeature: (user: User | null, feature: keyof UserPermissions): boolean => {
        const perms = getUserPermissions(user);
        return Boolean(perms[feature]);
    },

    // ‚úÖ NUEVA: Verificar si puede ver contenido espec√≠fico de ni√±os
    canViewOwnContent: (user: User | null): boolean => {
        if (!user) return false;
        const perms = getUserPermissions(user);
        return perms.canAccessOwnTraining || perms.canAccessOwnAssignments || perms.canAccessOwnProgress;
    },

    // ‚úÖ NUEVA: Verificar si puede gestionar otros usuarios
    canManageOthers: (user: User | null): boolean => {
        const perms = getUserPermissions(user);
        return perms.canManageKids;
    }
};